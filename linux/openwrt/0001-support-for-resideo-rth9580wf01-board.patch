From 7f8742087208d85a3ad4a7dd56d96d83ce5e5577 Mon Sep 17 00:00:00 2001
From: John Clark <inindev@gmail.com>
Date: Sat, 10 Apr 2021 07:57:20 -0400
Subject: [PATCH 1/3] support for resideo rth9580wf01 board

---
 .../files/arch/arm/boot/dts/rth9580wf01.dts   | 129 ++++++++++++++++++
 .../files/arch/arm/boot/dts/rth9580wf01.dtsi  |  79 +++++++++++
 target/linux/at91/image/sam9x.mk              |  14 ++
 ...6-ARM-at91-build-dtb-for-rth9580wf01.patch |  10 ++
 ...-ARM-at91-spi-nor-add-issi-is25lp128.patch |  10 ++
 target/linux/at91/sam9x/config-default        |  38 +++++-
 6 files changed, 273 insertions(+), 7 deletions(-)
 create mode 100644 target/linux/at91/files/arch/arm/boot/dts/rth9580wf01.dts
 create mode 100644 target/linux/at91/files/arch/arm/boot/dts/rth9580wf01.dtsi
 create mode 100644 target/linux/at91/patches-4.14/106-ARM-at91-build-dtb-for-rth9580wf01.patch
 create mode 100644 target/linux/at91/patches-4.14/107-ARM-at91-spi-nor-add-issi-is25lp128.patch

diff --git a/target/linux/at91/files/arch/arm/boot/dts/rth9580wf01.dts b/target/linux/at91/files/arch/arm/boot/dts/rth9580wf01.dts
new file mode 100644
index 0000000000..6a7244687b
--- /dev/null
+++ b/target/linux/at91/files/arch/arm/boot/dts/rth9580wf01.dts
@@ -0,0 +1,129 @@
+/*
+ * rth9580wf01.dts - Device Tree file for RTH9580WF01 Thermostat Board
+ *
+ * Licensed under GPLv2 or later.
+ */
+/dts-v1/;
+#include "rth9580wf01.dtsi"
+
+
+/ {
+	model = "Resideo RTH9580WF01";
+	compatible = "resideo,rth9580wf01", "atmel,at91sam9x5", "atmel,at91sam9";
+
+	chosen {
+		bootargs = "rootfstype=squashfs,jffs2 noinitrd console=ttyS0,115200";
+		stdout-path = "serial0:115200n8";
+		u-boot,dm-pre-reloc;
+	};
+
+	ahb {
+		apb {
+			i2c0: i2c@f8010000 {
+				status = "okay";
+			};
+
+			usart0: serial@f801c000 {
+				status = "okay";
+			};
+
+			hlcdc: hlcdc@f8038000 {
+				u-boot,dm-pre-reloc;
+				status = "okay";
+			};
+
+			spi0: spi@f0000000 {
+				cs-gpios = <&pioA 14 0>, <0>, <0>, <0>;
+				status = "okay";
+				u-boot,dm-pre-reloc;
+
+				spi_flash@0 {
+					#address-cells = <1>;
+					#size-cells = <1>;
+					compatible = "jedec,spi-nor";
+					reg = <0>;
+					spi-max-frequency = <50000000>;
+					m25p,fast-read;
+
+					spl@0 {
+						label = "spl";
+						reg = <0x0 0x8000>;
+					};
+					uenv1@8000 {
+						label = "uenv1";
+						reg = <0x8000 0x4000>;
+					};
+					uenv2@c000 {
+						label = "uenv2";
+						reg = <0xc000 0x4000>;
+					};
+					uboot@10000 {
+						label = "uboot";
+						reg = <0x10000 0xb0000>;
+					};
+					kernel@c0000 {
+						label = "kernel";
+						reg = <0xc0000 0x400000>;
+					};
+					rootfs@4c0000 {
+						label = "rootfs";
+						reg = <0x4c0000 0x400000>;
+					};
+					data@8c0000 {
+						label = "data";
+						reg = <0x8c0000 0x740000>;
+					};
+				};
+			};
+
+			ssc0: ssc@f0010000 {
+				status = "okay";
+			};
+
+			dbgu: serial@fffff200 {
+				u-boot,dm-pre-reloc;
+				status = "okay";
+			};
+
+			watchdog@fffffe40 {
+				status = "okay";
+			};
+
+			rtc@fffffeb0 {
+				status = "okay";
+			};
+		};
+	};
+
+	memory {
+		reg = <0x20000000 0x1000000>;
+	};
+
+	clocks {
+		slow_xtal {
+			clock-frequency = <32768>;
+		};
+
+		main_xtal {
+			clock-frequency = <12000000>;
+		};
+	};
+
+	leds {
+		compatible = "gpio-leds";
+
+		pb18 {
+			label = "pb18";
+			gpios = <&pioB 18 GPIO_ACTIVE_LOW>;
+			linux,default-trigger = "heartbeat";
+		};
+
+		pd21 {
+			label = "pd21";
+			gpios = <&pioD 21 GPIO_ACTIVE_HIGH>;
+		};
+	};
+
+};
+
+
diff --git a/target/linux/at91/files/arch/arm/boot/dts/rth9580wf01.dtsi b/target/linux/at91/files/arch/arm/boot/dts/rth9580wf01.dtsi
new file mode 100644
index 0000000000..cf49832b50
--- /dev/null
+++ b/target/linux/at91/files/arch/arm/boot/dts/rth9580wf01.dtsi
@@ -0,0 +1,79 @@
+/*
+ * rth9580wf01.dtsi - Device Tree Include file for RTH9580WF01 Thermostat Board
+ *
+ * Licensed under GPLv2 or later.
+ */
+
+#include "at91sam9x5.dtsi"
+#include "at91sam9x5_lcd.dtsi"
+#include "at91sam9x5_macb0.dtsi"
+
+
+/ {
+	model = "Atmel AT91SAM9G35 SoC";
+	compatible = "atmel,at91sam9g35", "atmel,at91sam9x5";
+
+	ahb {
+		apb {
+			i2c0: i2c@f8010000 {
+				qt1070: keyboard@1b {
+					compatible = "qt1070";
+					reg = <0x1b>;
+					interrupt-parent = <&pioA>;
+					interrupts = <7 0x0>;
+					pinctrl-names = "default";
+					pinctrl-0 = <&pinctrl_qt1070_irq>;
+					wakeup-source;
+				};
+			};
+
+			hlcdc: hlcdc@f8038000 {
+				atmel,vl-bpix = <4>;
+				atmel,guard-time = <1>;
+				pinctrl-names = "default";
+				pinctrl-0 = <&pinctrl_lcd_base &pinctrl_lcd_pwm &pinctrl_lcd_rgb888>;
+
+				display-timings {
+					u-boot,dm-pre-reloc;
+					480x272 {
+						clock-frequency = <24000000>;
+						hactive = <480>;
+						vactive = <272>;
+						hsync-len = <128>;
+						hfront-porch = <64>;
+						hback-porch = <64>;
+						vfront-porch = <22>;
+						vback-porch = <21>;
+						vsync-len = <2>;
+						u-boot,dm-pre-reloc;
+					};
+				};
+			};
+
+			adc0: adc@f804c000 {
+				atmel,adc-ts-wires = <4>;
+				atmel,adc-ts-pressure-threshold = <10000>;
+				status = "okay";
+			};
+
+			pinctrl@fffff400 {
+				board {
+					pinctrl_qt1070_irq: qt1070_irq {
+						atmel,pins =
+							<AT91_PIOA 7 AT91_PERIPH_GPIO AT91_PINCTRL_PULL_UP_DEGLITCH>;
+					};
+				};
+			};
+
+			pinctrl@fffff400 {
+				atmel,mux-mask = <
+				      /*    A         B          C     */
+				       0xffffffff 0xffe0399f 0xc000000c  /* pioA */
+				       0x000406ff 0x00047e3f 0x00000000  /* pioB */
+				       0xfdffffff 0x00000000 0xb83fffff  /* pioC */
+				       0x003fffff 0x003f8000 0x00000000  /* pioD */
+				      >;
+			};
+		};
+	};
+};
diff --git a/target/linux/at91/image/sam9x.mk b/target/linux/at91/image/sam9x.mk
index 3aada4c72b..2c6a691024 100644
--- a/target/linux/at91/image/sam9x.mk
+++ b/target/linux/at91/image/sam9x.mk
@@ -130,3 +130,17 @@ define Device/wb45n
   MKUBIFS_OPTS := -m $$(PAGESIZE) -e 124KiB -c 955
 endef
 TARGET_DEVICES += wb45n
+
+define Device/rth9580wf01
+  DEVICE_TITLE := Resideo RTH9580WF01
+  FILESYSTEMS := squashfs
+  BLOCKSIZE := 64k
+
+  KERNEL := kernel-bin | lzma | uImage lzma
+  KERNEL_INSTALL := 1
+  KERNEL_SUFFIX := -uImage
+
+  IMAGES := rootfs.bin
+  IMAGE/rootfs.bin = append-rootfs
+endef
+TARGET_DEVICES += rth9580wf01
diff --git a/target/linux/at91/patches-4.14/106-ARM-at91-build-dtb-for-rth9580wf01.patch b/target/linux/at91/patches-4.14/106-ARM-at91-build-dtb-for-rth9580wf01.patch
new file mode 100644
index 0000000000..f882df02bc
--- /dev/null
+++ b/target/linux/at91/patches-4.14/106-ARM-at91-build-dtb-for-rth9580wf01.patch
@@ -0,0 +1,10 @@
+--- a/arch/arm/boot/dts/Makefile
++++ b/arch/arm/boot/dts/Makefile
+@@ -47,6 +47,7 @@ dtb-$(CONFIG_SOC_AT91SAM9) += \
+ 	at91sam9g35ek.dtb \
+ 	at91sam9x25ek.dtb \
+ 	at91sam9x35ek.dtb \
++	rth9580wf01.dtb \
+ 	wb45n.dtb
+ dtb-$(CONFIG_SOC_SAM_V7) += \
+ 	at91-kizbox2.dtb \
diff --git a/target/linux/at91/patches-4.14/107-ARM-at91-spi-nor-add-issi-is25lp128.patch b/target/linux/at91/patches-4.14/107-ARM-at91-spi-nor-add-issi-is25lp128.patch
new file mode 100644
index 0000000000..343b61f44b
--- /dev/null
+++ b/target/linux/at91/patches-4.14/107-ARM-at91-spi-nor-add-issi-is25lp128.patch
@@ -0,0 +1,10 @@
+--- a/drivers/mtd/spi-nor/spi-nor.c
++++ b/drivers/mtd/spi-nor/spi-nor.c
+@@ -1027,6 +1027,8 @@ static const struct flash_info spi_nor_ids[] = {
+ 			SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ) },
+ 	{ "is25wp064", INFO(0x9d7017, 0, 64 * 1024, 128,
+ 			SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ) },
++	{ "is25lp128", INFO(0x9d6018, 0, 64 * 1024, 256,
++			SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ) },
+ 	{ "is25wp128", INFO(0x9d7018, 0, 64 * 1024, 256,
+ 			SECT_4K | SPI_NOR_DUAL_READ | SPI_NOR_QUAD_READ) },
diff --git a/target/linux/at91/sam9x/config-default b/target/linux/at91/sam9x/config-default
index a8923a6efe..5d82becf00 100644
--- a/target/linux/at91/sam9x/config-default
+++ b/target/linux/at91/sam9x/config-default
@@ -13,6 +13,7 @@ CONFIG_ATMEL_ST=y
 CONFIG_BACKLIGHT_ATMEL_LCDC=y
 # CONFIG_CACHE_L2X0 is not set
 CONFIG_CMA_DEBUGFS=y
+CONFIG_CMA_SIZE_MBYTES=1
 CONFIG_CPU_32v4T=y
 CONFIG_CPU_32v5=y
 CONFIG_CPU_ABRT_EV4T=y
@@ -33,6 +34,8 @@ CONFIG_CRC7=y
 CONFIG_CRC_CCITT=y
 CONFIG_CRC_ITU_T=y
 CONFIG_DEBUG_INFO=y
+# CONFIG_ETHERNET is not set
+# CONFIG_EXT4_FS is not set
 CONFIG_FB_ATMEL=y
 CONFIG_FB_BACKLIGHT=y
 CONFIG_FB_MODE_HELPERS=y
@@ -41,24 +44,45 @@ CONFIG_GENERIC_ATOMIC64=y
 CONFIG_HZ=128
 CONFIG_HZ_FIXED=128
 CONFIG_HZ_PERIODIC=y
+# CONFIG_ISDN is not set
+CONFIG_JFFS2_FS=y
+# CONFIG_JFFS2_FS_XATTR is not set
+# CONFIG_JFFS2_LZMA is not set
+# CONFIG_JFFS2_RTIME is not set
+CONFIG_JFFS2_ZLIB=y
+# CONFIG_LBDAF is not set
+# CONFIG_MEDIA_SUPPORT is not set
 # CONFIG_MFD_ACT8945A is not set
 # CONFIG_MFD_ATMEL_FLEXCOM is not set
-# CONFIG_MMC_SDHCI is not set
-CONFIG_MMC_SPI=y
-# CONFIG_MTD_SPI_NOR is not set
+# CONFIG_MMC is not set
+# CONFIG_MTD_NAND is not set
+CONFIG_MTD_SPI_NOR_USE_4K_SECTORS=y
+CONFIG_MTD_SPI_NOR_USE_4K_SECTORS_LIMIT=16384
+# CONFIG_MTD_UBI is not set
 CONFIG_NEED_KUSER_HELPERS=y
+# CONFIG_NETWORK_FILESYSTEMS is not set
+# CONFIG_NEW_LEDS is not set
 # CONFIG_NO_HZ_IDLE is not set
 # CONFIG_POWER_RESET_AT91_SAMA5D2_SHDWC is not set
 # CONFIG_REGULATOR_ACT8865 is not set
 CONFIG_RTC_DRV_AT91SAM9=y
 # CONFIG_SAMA5D4_WATCHDOG is not set
-# CONFIG_SND_ARM is not set
-# CONFIG_SND_ATMEL_SOC_CLASSD is not set
-# CONFIG_SND_DRIVERS is not set
-# CONFIG_SND_SPI is not set
+# CONFIG_SCSI is not set
+# CONFIG_SCSI_DMA is not set
+# CONFIG_SG_POOL is not set
 CONFIG_SOC_AT91RM9200=y
 CONFIG_SOC_AT91SAM9=y
 CONFIG_SOC_SAM_V4_V5=y
+# CONFIG_SOUND is not set
+# CONFIG_SPI_BITBANG is not set
+# CONFIG_SPI_DYNAMIC is not set
+# CONFIG_SPI_GPIO is not set
 CONFIG_SPLIT_PTLOCK_CPUS=999999
+CONFIG_SQUASHFS=y
+# CONFIG_SQUASHFS_XZ is not set
+CONFIG_SQUASHFS_ZLIB=y
+# CONFIG_STAGING is not set
 CONFIG_TOUCHSCREEN_ADS7846=y
 # CONFIG_TOUCHSCREEN_ATMEL_MXT is not set
+# CONFIG_USB_SUPPORT is not set
+# CONFIG_VFAT_FS is not set
-- 
2.20.1

