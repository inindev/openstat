From bd8c0f83701eac89f90bbb0424c5e298b78990f6 Mon Sep 17 00:00:00 2001
From: John Clark <inindev@gmail.com>
Date: Tue, 23 Mar 2021 18:49:42 -0400
Subject: [PATCH] board files for resideo rth9580wf01 thermostat

---
 arch/arm/dts/Makefile                   |   2 +
 arch/arm/dts/rth9580wf01.dts            | 129 ++++++++++++++++++++++++
 arch/arm/dts/rth9580wf01.dtsi           |  77 ++++++++++++++
 arch/arm/mach-at91/Kconfig              |  12 +++
 board/resideo/common                    |   1 +
 board/resideo/rth9580wf01/Kconfig       |  12 +++
 board/resideo/rth9580wf01/MAINTAINERS   |   6 ++
 board/resideo/rth9580wf01/Makefile      |  14 +++
 board/resideo/rth9580wf01/rth9580wf01.c |  74 ++++++++++++++
 configs/rth9580wf01_spiflash_defconfig  |  81 +++++++++++++++
 include/configs/rth9580wf01.h           |  64 ++++++++++++
 11 files changed, 472 insertions(+)
 create mode 100644 arch/arm/dts/rth9580wf01.dts
 create mode 100644 arch/arm/dts/rth9580wf01.dtsi
 create mode 120000 board/resideo/common
 create mode 100644 board/resideo/rth9580wf01/Kconfig
 create mode 100644 board/resideo/rth9580wf01/MAINTAINERS
 create mode 100644 board/resideo/rth9580wf01/Makefile
 create mode 100644 board/resideo/rth9580wf01/rth9580wf01.c
 create mode 100644 configs/rth9580wf01_spiflash_defconfig
 create mode 100644 include/configs/rth9580wf01.h

diff --git a/arch/arm/dts/Makefile b/arch/arm/dts/Makefile
index c6710826a0..92df9b3c83 100644
--- a/arch/arm/dts/Makefile
+++ b/arch/arm/dts/Makefile
@@ -875,6 +875,8 @@ dtb-$(CONFIG_TARGET_AT91SAM9X5EK) += \
 	at91sam9x25ek.dtb	\
 	at91sam9x35ek.dtb
 
+dtb-$(CONFIG_TARGET_RTH9580WF01) += rth9580wf01.dtb
+
 dtb-$(CONFIG_TARGET_SAM9X60EK) += sam9x60ek.dtb
 
 dtb-$(CONFIG_TARGET_AT91SAM9N12EK) += at91sam9n12ek.dtb
diff --git a/arch/arm/dts/rth9580wf01.dts b/arch/arm/dts/rth9580wf01.dts
new file mode 100644
index 0000000000..df726a05db
--- /dev/null
+++ b/arch/arm/dts/rth9580wf01.dts
@@ -0,0 +1,129 @@
+/*
+ * rth9580wf01.dts - Device Tree file for RTH9580WF01 Thermostat Board
+ *
+ * Licensed under GPLv2 or later.
+ */
+/dts-v1/;
+#include "rth9580wf01.dtsi"
+
+
+/ {
+	model = "Resideo RTH9580WF01";
+	compatible = "resideo,rth9580wf01", "atmel,at91sam9x5", "atmel,at91sam9";
+
+	chosen {
+		bootargs = "rootfstype=squashfs,jffs2 noinitrd console=ttyS0,115200";
+		stdout-path = "serial0:115200n8";
+		u-boot,dm-pre-reloc;
+	};
+
+	ahb {
+		apb {
+			i2c0: i2c@f8010000 {
+				status = "okay";
+			};
+
+			usart0: serial@f801c000 {
+				status = "okay";
+			};
+
+			hlcdc: hlcdc@f8038000 {
+				status = "okay";
+				u-boot,dm-pre-reloc;
+			};
+
+			spi0: spi@f0000000 {
+				cs-gpios = <&pioA 14 0>, <0>, <0>, <0>;
+				status = "okay";
+				u-boot,dm-pre-reloc;
+
+				spi_flash@0 {
+					#address-cells = <1>;
+					#size-cells = <1>;
+					compatible = "jedec,spi-nor";
+					reg = <0>;
+					spi-max-frequency = <50000000>;
+					m25p,fast-read;
+
+					spl@0 {
+						label = "spl";
+						reg = <0x0 0x8000>;
+					};
+					uenv1@8000 {
+						label = "uenv1";
+						reg = <0x8000 0x4000>;
+					};
+					uenv2@c000 {
+						label = "uenv2";
+						reg = <0xc000 0x4000>;
+					};
+					uboot@10000 {
+						label = "uboot";
+						reg = <0x10000 0xb0000>;
+					};
+					kernel@c0000 {
+						label = "kernel";
+						reg = <0xc0000 0x400000>;
+					};
+					rootfs@4c0000 {
+						label = "rootfs";
+						reg = <0x4c0000 0x400000>;
+					};
+					data@8c0000 {
+						label = "data";
+						reg = <0x8c0000 0x740000>;
+					};
+				};
+			};
+
+			ssc0: ssc@f0010000 {
+				status = "okay";
+			};
+
+			dbgu: serial@fffff200 {
+				u-boot,dm-pre-reloc;
+				status = "okay";
+			};
+
+			watchdog@fffffe40 {
+				status = "okay";
+			};
+
+			rtc@fffffeb0 {
+				status = "okay";
+			};
+		};
+	};
+
+	memory {
+		reg = <0x20000000 0x1000000>;
+	};
+
+	clocks {
+		slow_xtal {
+			clock-frequency = <32768>;
+		};
+
+		main_xtal {
+			clock-frequency = <12000000>;
+		};
+	};
+
+	leds {
+		compatible = "gpio-leds";
+
+		pb18 {
+			label = "pb18";
+			gpios = <&pioB 18 GPIO_ACTIVE_LOW>;
+			linux,default-trigger = "heartbeat";
+		};
+
+		pd21 {
+			label = "pd21";
+			gpios = <&pioD 21 GPIO_ACTIVE_HIGH>;
+		};
+	};
+
+};
+
+
diff --git a/arch/arm/dts/rth9580wf01.dtsi b/arch/arm/dts/rth9580wf01.dtsi
new file mode 100644
index 0000000000..1d82770a0a
--- /dev/null
+++ b/arch/arm/dts/rth9580wf01.dtsi
@@ -0,0 +1,77 @@
+/*
+ * rth9580wf01.dtsi - Device Tree Include file for RTH9580WF01 Thermostat Board
+ *
+ * Licensed under GPLv2 or later.
+ */
+
+#include "at91sam9x5.dtsi"
+#include "at91sam9x5_lcd.dtsi"
+#include "at91sam9x5_macb0.dtsi"
+
+
+/ {
+	model = "Atmel AT91SAM9G35 SoC";
+	compatible = "atmel,at91sam9g35", "atmel,at91sam9x5";
+
+	ahb {
+		apb {
+			i2c0: i2c@f8010000 {
+				qt1070: keyboard@1b {
+					compatible = "qt1070";
+					reg = <0x1b>;
+					interrupt-parent = <&pioA>;
+					interrupts = <7 0x0>;
+					pinctrl-names = "default";
+					pinctrl-0 = <&pinctrl_qt1070_irq>;
+					wakeup-source;
+				};
+			};
+
+			hlcdc: hlcdc@f8038000 {
+				atmel,vl-bpix = <4>;
+				atmel,guard-time = <1>;
+				pinctrl-names = "default";
+				pinctrl-0 = <&pinctrl_lcd_base &pinctrl_lcd_pwm &pinctrl_lcd_rgb888>;
+
+				display-timings {
+					480x272 {
+						clock-frequency = <9000000>;
+						hactive = <480>;
+						vactive = <272>;
+						hsync-len = <41>;
+						hfront-porch = <2>;
+						hback-porch = <2>;
+						vfront-porch = <2>;
+						vback-porch = <2>;
+						vsync-len = <11>;
+					};
+				};
+			};
+
+			adc0: adc@f804c000 {
+				atmel,adc-ts-wires = <4>;
+				atmel,adc-ts-pressure-threshold = <10000>;
+				status = "okay";
+			};
+
+			pinctrl@fffff400 {
+				board {
+					pinctrl_qt1070_irq: qt1070_irq {
+						atmel,pins =
+							<AT91_PIOA 7 AT91_PERIPH_GPIO AT91_PINCTRL_PULL_UP_DEGLITCH>;
+					};
+				};
+			};
+
+			pinctrl@fffff400 {
+				atmel,mux-mask = <
+				      /*    A         B          C     */
+				       0xffffffff 0xffe0399f 0xc000000c  /* pioA */
+				       0x000406ff 0x00047e3f 0x00000000  /* pioB */
+				       0xfdffffff 0x00000000 0xb83fffff  /* pioC */
+				       0x003fffff 0x003f8000 0x00000000  /* pioD */
+				      >;
+			};
+		};
+	};
+};
diff --git a/arch/arm/mach-at91/Kconfig b/arch/arm/mach-at91/Kconfig
index c78a308f48..69e442de89 100644
--- a/arch/arm/mach-at91/Kconfig
+++ b/arch/arm/mach-at91/Kconfig
@@ -65,6 +65,10 @@ config SAMA5D4
 	select CPU_V7A
 	select ATMEL_SFR
 
+config RTH9580WF01
+	bool
+	select CPU_ARM926EJS
+
 choice
 	prompt "Atmel AT91 board select"
 	optional
@@ -251,6 +255,13 @@ config TARGET_SAMA5D4EK
 	select SAMA5D4
 	select SUPPORT_SPL
 
+config TARGET_RTH9580WF01
+	bool "Resideo RTH9580WF01 thermostat board"
+	select RTH9580WF01
+	select AT91SAM9X5
+	select BOARD_EARLY_INIT_F
+	select BOARD_LATE_INIT
+
 config TARGET_MEESC
 	bool "Support meesc"
 	select AT91SAM9263
@@ -344,6 +355,7 @@ source "board/atmel/sama5d3_xplained/Kconfig"
 source "board/atmel/sama5d3xek/Kconfig"
 source "board/atmel/sama5d4_xplained/Kconfig"
 source "board/atmel/sama5d4ek/Kconfig"
+source "board/resideo/rth9580wf01/Kconfig"
 source "board/bluewater/gurnard/Kconfig"
 source "board/bluewater/snapper9260/Kconfig"
 source "board/calao/usb_a9263/Kconfig"
diff --git a/board/resideo/common b/board/resideo/common
new file mode 120000
index 0000000000..0d3c28fa07
--- /dev/null
+++ b/board/resideo/common
@@ -0,0 +1 @@
+../atmel/common
\ No newline at end of file
diff --git a/board/resideo/rth9580wf01/Kconfig b/board/resideo/rth9580wf01/Kconfig
new file mode 100644
index 0000000000..015b7c9601
--- /dev/null
+++ b/board/resideo/rth9580wf01/Kconfig
@@ -0,0 +1,12 @@
+if TARGET_RTH9580WF01
+
+config SYS_BOARD
+	default "rth9580wf01"
+
+config SYS_VENDOR
+	default "resideo"
+
+config SYS_CONFIG_NAME
+	default "rth9580wf01"
+
+endif
diff --git a/board/resideo/rth9580wf01/MAINTAINERS b/board/resideo/rth9580wf01/MAINTAINERS
new file mode 100644
index 0000000000..0fccb46825
--- /dev/null
+++ b/board/resideo/rth9580wf01/MAINTAINERS
@@ -0,0 +1,6 @@
+RTH9580WF01 BOARD
+M:	John Clark <inindev@gmail.com>
+S:	Maintained
+F:	board/resideo/rth9580wf01/
+F:	include/configs/rth9580wf01.h
+F:	configs/rth9580wf01_spiflash_defconfig
diff --git a/board/resideo/rth9580wf01/Makefile b/board/resideo/rth9580wf01/Makefile
new file mode 100644
index 0000000000..5115859e5f
--- /dev/null
+++ b/board/resideo/rth9580wf01/Makefile
@@ -0,0 +1,14 @@
+# SPDX-License-Identifier: GPL-2.0+
+#
+# (C) Copyright 2003-2008
+# Wolfgang Denk, DENX Software Engineering, wd@denx.de.
+#
+# (C) Copyright 2008
+# Stelian Pop <stelian@popies.net>
+# Lead Tech Design <www.leadtechdesign.com>
+#
+# (C) Copyright 2012
+# Bo Shen <voice.shen@atmel.com>
+# Atmel corporation <www.atmel.com>
+
+obj-y += rth9580wf01.o
diff --git a/board/resideo/rth9580wf01/rth9580wf01.c b/board/resideo/rth9580wf01/rth9580wf01.c
new file mode 100644
index 0000000000..dca0f20302
--- /dev/null
+++ b/board/resideo/rth9580wf01/rth9580wf01.c
@@ -0,0 +1,74 @@
+// SPDX-License-Identifier: GPL-2.0+
+/*
+ * Copyright (C) 2012 Atmel Corporation
+ */
+
+#include <common.h>
+#include <init.h>
+#include <asm/io.h>
+#include <asm/arch/at91sam9x5_matrix.h>
+#include <asm/arch/at91sam9_smc.h>
+#include <asm/arch/at91_common.h>
+#include <asm/arch/at91_rstc.h>
+#include <asm/arch/clk.h>
+#include <asm/arch/gpio.h>
+#include <debug_uart.h>
+#include <asm/mach-types.h>
+
+DECLARE_GLOBAL_DATA_PTR;
+
+/* ------------------------------------------------------------------------- */
+/*
+ * Miscelaneous platform dependent initialisations
+ */
+
+void at91_prepare_cpu_var(void);
+
+#ifdef CONFIG_BOARD_LATE_INIT
+int board_late_init(void)
+{
+#ifdef CONFIG_DM_VIDEO
+	at91_video_show_board_info();
+#endif
+	at91_prepare_cpu_var();
+	return 0;
+}
+#endif
+
+#ifdef CONFIG_DEBUG_UART_BOARD_INIT
+void board_debug_uart_init(void)
+{
+	at91_seriald_hw_init();
+}
+#endif
+
+#ifdef CONFIG_BOARD_EARLY_INIT_F
+int board_early_init_f(void)
+{
+#ifdef CONFIG_DEBUG_UART
+	debug_uart_init();
+#endif
+	return 0;
+}
+#endif
+
+int board_init(void)
+{
+	/* arch number of AT91SAM9X5EK-Board */
+	gd->bd->bi_arch_number = MACH_TYPE_AT91SAM9X5EK;
+
+	/* adress of boot parameters */
+	gd->bd->bi_boot_params = CONFIG_SYS_SDRAM_BASE + 0x100;
+
+#if defined(CONFIG_USB_OHCI_NEW) || defined(CONFIG_USB_EHCI_HCD)
+	at91_uhp_hw_init();
+#endif
+	return 0;
+}
+
+int dram_init(void)
+{
+	gd->ram_size = get_ram_size((void *) CONFIG_SYS_SDRAM_BASE,
+					CONFIG_SYS_SDRAM_SIZE);
+	return 0;
+}
diff --git a/configs/rth9580wf01_spiflash_defconfig b/configs/rth9580wf01_spiflash_defconfig
new file mode 100644
index 0000000000..b092b51187
--- /dev/null
+++ b/configs/rth9580wf01_spiflash_defconfig
@@ -0,0 +1,81 @@
+CONFIG_ARM=y
+CONFIG_ARCH_AT91=y
+CONFIG_SYS_TEXT_BASE=0x20f50000
+CONFIG_TARGET_RTH9580WF01=y
+CONFIG_SYS_MALLOC_F_LEN=0x2000
+CONFIG_NR_DRAM_BANKS=1
+CONFIG_ENV_SIZE=0x4000
+CONFIG_ENV_OFFSET=0x8000
+CONFIG_ENV_SECT_SIZE=0x1000
+CONFIG_DM_GPIO=y
+CONFIG_DEBUG_UART_BOARD_INIT=y
+CONFIG_DEBUG_UART_BASE=0xfffff200
+CONFIG_DEBUG_UART_CLOCK=132000000
+CONFIG_ENV_OFFSET_REDUND=0xc000
+CONFIG_DEFAULT_DEVICE_TREE="rth9580wf01"
+CONFIG_DEBUG_UART=y
+CONFIG_FIT=y
+CONFIG_SPI_BOOT=y
+# CONFIG_CONSOLE_MUX is not set
+CONFIG_SYS_CONSOLE_IS_IN_ENV=y
+CONFIG_LOG=y
+CONFIG_HUSH_PARSER=y
+CONFIG_SYS_PROMPT="uboot> "
+CONFIG_CMD_BOOTZ=y
+# CONFIG_BOOTM_NETBSD is not set
+# CONFIG_BOOTM_PLAN9 is not set
+# CONFIG_BOOTM_RTEMS is not set
+# CONFIG_BOOTM_VXWORKS is not set
+# CONFIG_CMD_ELF is not set
+CONFIG_CMD_MEMINFO=y
+CONFIG_CMD_DM=y
+# CONFIG_CMD_FLASH is not set
+CONFIG_CMD_GPIO=y
+CONFIG_CMD_MTD=y
+CONFIG_CMD_SDRAM=y
+# CONFIG_CMD_SETEXPR is not set
+CONFIG_CMD_SQUASHFS=y
+CONFIG_CMD_JFFS2=y
+CONFIG_CMD_MTDPARTS=y
+CONFIG_MTDIDS_DEFAULT="nor0=spi-flash.0"
+CONFIG_MTDPARTS_DEFAULT="mtdparts=spi-flash.0:32k(spl),16k(uenv1),16k(uenv2),704k(uboot),4m(kernel),4m(rootfs),-(data)"
+# CONFIG_PARTITIONS is not set
+CONFIG_OF_CONTROL=y
+CONFIG_ENV_IS_IN_SPI_FLASH=y
+CONFIG_USE_ENV_SPI_BUS=y
+CONFIG_ENV_SPI_BUS=0
+CONFIG_USE_ENV_SPI_CS=y
+CONFIG_ENV_SPI_CS=0
+CONFIG_USE_ENV_SPI_MAX_HZ=y
+CONFIG_ENV_SPI_MAX_HZ=50000000
+CONFIG_USE_ENV_SPI_MODE=y
+CONFIG_ENV_SPI_MODE=0x0
+CONFIG_SYS_REDUNDAND_ENVIRONMENT=y
+CONFIG_SYS_RELOC_GD_ENV_ADDR=y
+# CONFIG_NET is not set
+CONFIG_DM=y
+CONFIG_CLK=y
+CONFIG_CLK_AT91=y
+CONFIG_AT91_GPIO=y
+# CONFIG_MMC is not set
+CONFIG_MTD=y
+CONFIG_DM_MTD=y
+CONFIG_DM_SPI_FLASH=y
+CONFIG_SF_DEFAULT_MODE=0
+CONFIG_SF_DEFAULT_SPEED=50000000
+CONFIG_SPI_FLASH_ISSI=y
+CONFIG_SPI_FLASH_WINBOND=y
+CONFIG_SPI_FLASH_MTD=y
+CONFIG_PINCTRL=y
+CONFIG_PINCTRL_AT91=y
+CONFIG_DM_SERIAL=y
+CONFIG_ATMEL_USART=y
+CONFIG_SPI=y
+CONFIG_DM_SPI=y
+CONFIG_TIMER=y
+CONFIG_ATMEL_PIT_TIMER=y
+CONFIG_DM_VIDEO=y
+# CONFIG_VIDEO_BPP8 is not set
+# CONFIG_VIDEO_BPP32 is not set
+CONFIG_ATMEL_HLCD=y
+CONFIG_LZMA=y
diff --git a/include/configs/rth9580wf01.h b/include/configs/rth9580wf01.h
new file mode 100644
index 0000000000..bb1117569e
--- /dev/null
+++ b/include/configs/rth9580wf01.h
@@ -0,0 +1,64 @@
+/* SPDX-License-Identifier: GPL-2.0+ */
+/*
+ * configuation settings for the rth9580wf01 board
+ */
+
+#ifndef __RTH9580WF01_H__
+#define __RTH9580WF01_H__
+
+/* ARM asynchronous clock */
+#define CONFIG_SYS_AT91_SLOW_CLOCK	32768
+#define CONFIG_SYS_AT91_MAIN_CLOCK	12000000	/* 12 MHz crystal */
+
+#define CONFIG_CMDLINE_TAG		/* enable passing of ATAGs */
+#define CONFIG_SETUP_MEMORY_TAGS
+#define CONFIG_INITRD_TAG
+#define CONFIG_SKIP_LOWLEVEL_INIT
+
+/* general purpose I/O */
+#define CONFIG_ATMEL_LEGACY		/* required until (g)pio is fixed */
+
+/* BOOTP options */
+#define CONFIG_BOOTP_BOOTFILESIZE
+#define CONFIG_BOOTP_BOOTPATH
+#define CONFIG_BOOTP_GATEWAY
+#define CONFIG_BOOTP_HOSTNAME
+
+/* SDRAM */
+#define CONFIG_SYS_SDRAM_BASE		0x20000000
+#define CONFIG_SYS_SDRAM_SIZE		0x01000000	/* 16 megs */
+
+#define CONFIG_SYS_INIT_SP_ADDR \
+	(CONFIG_SYS_SDRAM_BASE + 16 * 1024 - GENERATED_GBL_DATA_SIZE)
+
+/* USB */
+#ifdef CONFIG_CMD_USB
+#ifndef CONFIG_USB_EHCI_HCD
+#define CONFIG_USB_ATMEL
+#define CONFIG_USB_ATMEL_CLK_SEL_UPLL
+#define CONFIG_USB_OHCI_NEW
+#define CONFIG_SYS_USB_OHCI_CPU_INIT
+#define CONFIG_SYS_USB_OHCI_REGS_BASE		ATMEL_BASE_OHCI
+#define CONFIG_SYS_USB_OHCI_SLOT_NAME		"at91sam9x5"
+#define CONFIG_SYS_USB_OHCI_MAX_ROOT_PORTS	3
+#endif
+#endif
+
+#define CONFIG_SYS_LOAD_ADDR		0x20f50000	/* load address */
+
+/* bootstrap + u-boot + env1 + env2  + linux in spi flash */
+#define CONFIG_BOOTCOMMAND	"sf probe 0; " \
+				"sf read 0x20800000 0xc0000 0x400000; " \
+				"bootm 0x20800000 - 0x${fdtcontroladdr}"
+
+/*
+ * Size of malloc() pool
+ */
+#define CONFIG_SYS_MALLOC_LEN		(256 << 10)	/* reserve 256k for malloc() */
+
+#define CONFIG_SYS_MASTER_CLOCK		132096000
+#define CONFIG_SYS_AT91_PLLA		0x20c73f03
+#define CONFIG_SYS_MCKR			0x1301
+#define CONFIG_SYS_MCKR_CSS		0x1302
+
+#endif /* __RTH9580WF01_H__ */
-- 
2.20.1

